/**
 * PageSnippets - dynamically load and produce HTML or XML.
 * @version 2.1
 * @copyright Copyright 2023 Christoph Zager
 * @link https://github.com/suppenhuhn79/pagesnippets
 * @license Apache-2.0 - See the full license text at http://www.apache.org/licenses/LICENSE-2.0
 */
let pageSnippets=new function(){const e="https://github.com/suppenhuhn79/pagesnippets",t="http://www.w3.org/1999/xhtml";let n=new XMLSerializer,r=new Map;function a(e,t=!1){return e.constructor===Array&&(e=e.join("/")),("/"+e+(!0===t?"/":"")).replace(/\/+/g,"/")}function i(e,t,r){let a=n.serializeToString(e);return a.substring(0,a.indexOf(">")+1)+"\t@"+t+"\n"+r}function s(e){return e.replace(/\sxmlns(=|:[^=]+=)"[^"]+"/gi,"").trim()}this.locale="default",this.import=function(n){return new Promise(((a,s)=>{Array.from(r.values()).filter((e=>e.source===n)).length>0?a():fetch(n).then((o=>{function l(e){let t="";if(/^(http[s]?:\/\/|\/)/.test(e))t=e;else{let r=n.replace(/[^./]+\.[\S]+$/,"");e=e.replace(/^\.\//,""),t=r.concat(e).replace(/[^/]+\/\.\.\//g,"")}return t}function c(t,r,a){let s=[];for(let o of t.children){let t=i(o,n,a);if(o.namespaceURI===e)if("snippet"===o.localName)u(o,r,t);else if("snippet-group"===o.localName){let e=o.getAttribute("name");c(o,r+"/"+e,t)}else""===r&&"stylesheet"===o.localName?p(o):""===r&&"script"===o.localName&&s.push(o)}""===r&&f(s)}function u(e,a,i){let s=a+"/"+e.getAttribute("name");r.set(s,{source:n,key:s,namespace:e.firstElementChild.namespaceURI||t,data:e.firstElementChild}),e.childElementCount}function p(e){let t=l(e.getAttribute("src"));if(null===document.querySelector('link[rel="stylesheet"][href="'+t+'"]')){let e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("href",t),document.head.appendChild(e)}}function f(e){function t(t){"error"===t.type||f(e.slice(1))}if(e.length>0){let n=l(e[0].getAttribute("src"));if(null===document.querySelector('script[src="'+n+'"]')){let e=document.createElement("script");e.addEventListener("load",t),e.addEventListener("error",t),e.setAttribute("src",n),document.head.appendChild(e)}else f(e.slice(1))}else a()}if(200===o.status)o.text().then((t=>{let r;try{r=(new DOMParser).parseFromString(t,"text/xml")}finally{if(r.documentElement.namespaceURI===e&&"pagesnippets"===r.documentElement.localName)c(r.firstElementChild,"","");else{let e=new Error('"'+n+'" is not a PageSnippets XML-document.');s(e)}}}));else{let e=new ReferenceError("Server returned "+o.status+" ("+o.statusText+") when trying to fetch "+o.url);s(e)}}),(e=>{s(new Error(e))}))}))},this.produce=function(n,o={},l=""){function c(e,t,n="."){let r;if(e&&t){let a=t.split(n);r=1===a.length?e[a[0]]:c(e[a[0]],a.splice(1).join(n),n)}return r}function u(e,t,n){let r=e,a=/\{\{(.*?)\}\}/g,i=a.exec(e);for(;i;){let s=c(t,i[1])??"";if("number"==typeof s){let e=n?.attributes.getNamedItem("number-format")?.value;if(e){let t=/^\+?[^.]+/.exec(e)?.[0]??"0",n=/\.(.*)$/.exec(e)?.[1]??"",a=Math.max(n.replace(/[^0]/g,"").length,1),o=s.toLocaleString(void 0,{roundingPriority:"lessPrecision",roundingMode:"trunc",useGrouping:e.includes(","),signDisplay:e.includes("+")?"always":"auto",trailingZeroDisplay:/\.#/.test(e)?"stripIfInteger":"auto",minimumIntegerDigits:Math.max(t.replace(/[^0]/g,"").length,1),minimumFractionDigits:a,maximumFractionDigits:Math.max(n.length,a)});r=r.replace(i[0],o)}else r=r.replace(i[0],s.toString())}else if(s instanceof Date){let e=n?.attributes.getNamedItem("date-format")?.value;if(e){for(let t of e.matchAll(/D{1,4}|d{1,2}|M{1,4}|m{1,2}|y{4}|y{2}|h{1,2}|n{2}|s{2}/g)){let n=t[0],r=n.length,a="";switch(n){case"d":case"dd":a=s.getDate().toString();break;case"D":case"DD":case"DDD":case"DDDD":a=s.toLocaleDateString(pageSnippets.locale,{weekday:"long"}),r<4&&(a=a.substring(0,r));break;case"m":case"mm":a=(s.getMonth()+1).toString();break;case"M":case"MM":case"MMM":case"MMMM":a=s.toLocaleDateString(pageSnippets.locale,{month:"long"}),r<4&&(a=a.substring(0,r));break;case"yy":a=s.getFullYear().toString().substring(2,4);break;case"yyyy":a=s.getFullYear().toString();break;case"h":case"hh":a=s.getHours().toString();break;case"nn":a=s.getMinutes().toString();break;case"ss":a=s.getSeconds().toString();break;default:a=""}e=e.replace(n,a.padStart(r,"0"))}r=r.replace(i[0],e)}else r=r.replace(i[0],s.toJSON())}else r=r.replace(i[0],s.toString());i=a.exec(e)}return r}function p(n,r,a,s){for(let o of n.childNodes)switch(o.nodeType){case 1:let n=i(o,w,s);if(o.namespaceURI===e)switch(o.localName){case"call-function":m(o,r,a,n);break;case"choose":b(o,r,a,n);break;case"for-each":d(o,r,a,n);break;case"for-empty":h(o,r,a,n);break;case"if":S(o,r,a,n);break;case"insert-snippet":y(o,r,a,n);break;case"text":r.appendChild(document.createTextNode(u(o.firstChild.data,a,o)));break;default:}else{let e=document.createElementNS(o.namespaceURI||t,o.tagName);f(o,e,a,n),p(o,e,a,n),g(o,e,a,n),r.appendChild(e)}break;case 3:!1===/^\s*$/.test(o.textContent)&&r.appendChild(document.createTextNode(u(o.textContent,a,o.parentElement)));break}}function f(t,n,r,a){for(let a of t.attributes)if(a.namespaceURI===e)if(/^on\S+/.test(a.localName)){let e=c(r,a.value);"function"==typeof e&&(n[a.localName]=e)}else a.localName;else n.setAttributeNS(a.namespaceURI,a.localName,u(a.value,r))}function g(t,n,r,a){let i=t.getAttributeNS(e,"postproduction");if(i){n.removeAttributeNS(e,"postproduction");let t=c(r,i);if("function"!=typeof t)throw new ReferenceError('Post-production reference "'+i+'" is not a function.\n'+s(a));t(n,r)}}function m(t,n,r,a){let i=t.getAttributeNS(e,"name")||t.getAttribute("name");if("function"!=typeof r[i])throw new ReferenceError('Reference to call "'+i+'" is not a function.\n'+s(a));r[i](n,r)}function d(t,n,r,a){let i=t.getAttributeNS(e,"list")||t.getAttribute("list"),o=c(r,i);if(o?.constructor!==Array)throw new TypeError('"'+i+'" is '+(o?.constructor.name??"undefined")+", expected Array.\n"+s(a));{let e=0,i=o.length;for(let s of o){let o=["string","number","boolean"].includes(typeof s)||s.constructor===Array?{_value:s}:Object.assign({},s);o._position=e+=1,o._count=i,p(t,n,Object.assign({},r,o),a)}}}function h(t,n,r,a){let i=c(r,t.getAttributeNS(e,"list")||t.getAttribute("list"));i?.constructor===Array&&0!==i.length||p(t,n,r,a)}function b(t,n,r,a){const s="strict";let o=(RegExp("^strict$|^lax$").exec(t.getAttribute("mode")||s)||[""])[0];""===o&&(o=s);let l=!1;for(let c of t.children){let t=i(c,w,a);if(c.namespaceURI===e&&"if"===c.localName){let e=S(c,n,r,t);if(l=l||e,l&&o===s)break}else c.namespaceURI===e&&"else"===c.localName&&!1===l&&p(c,n,r,t)}}function S(t,n,r,a){let i,o=t.getAttributeNS(e,"test")||t.getAttribute("test"),l="return ("+o.replace(/'?\{\{/g,"this.").replace(/\}\}'?/g,"")+")";try{i=Function(l).call(r)}catch(e){throw new e.constructor('Cannot evaluate expression "'+o+'": '+e.message+".\n"+s(a))}return!0===i&&p(t,n,r,a),i}function y(t,n,i,o){let l=a(u(t.getAttributeNS(e,"name")||t.getAttribute("name"),i));if(!r.has(l))throw new ReferenceError('Unknown snippet "'+l+'".\n'+s(o));n.appendChild(pageSnippets.produce(l,i,o))}if(!1===["string","undefined"].includes(typeof l))throw new TypeError("Prohibited usage of _parentSnippetRef");let w;if(n=a(n),this.getSnippet(n)){let e=r.get(n);if(l.includes(e.source+":"+n))throw new Error("Recursive snippet nesting.\n"+s(l));let t=i(e.data,e.source+":"+n,l),a=document.createElementNS(e.namespace,e.data.localName);return w=e.source+":"+n,f(e.data,a,o),p(e.data,a,o,t),g(e.data,a,o,t),a}},this.hasSnippet=function(e){return r.has(e)},this.getSnippet=function(e){if(r.has(e))return r.get(a(e));throw new ReferenceError('No such snippet: "'+e+'".')},this.getSnippets=function(e="",t=!1){let n=[],i=new RegExp("^("+a(e,!0)+"[^/]+)$");if(e=a(e,!0),n=n.concat(Array.from(r.keys()).filter((e=>i.test(e)))),!0===t)for(let t of this.getSnippetGroups(e))n=n.concat(this.getSnippets(t,!0));return n},this.getSnippetGroups=function(e="",t=!1){let n=new RegExp("^("+a(e,!0)+"[^/]+/)"),i=new Set;for(let e of r.keys()){let r=n.exec(e);r&&!1===i.has(r[1])&&(i.add(r[1]),!0===t&&this.getSnippetGroups(r[1],t).forEach((e=>i.add(e))))}return Array.from(i)}};