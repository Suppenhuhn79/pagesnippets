/**
 * PageSnippets - dynamically load and produce HTML or XML.
 * @version 2.1
 * @copyright Copyright 2023 Christoph Zager
 * @link https://github.com/suppenhuhn79/pagesnippets
 * @license Apache-2.0 - See the full license text at http://www.apache.org/licenses/LICENSE-2.0
 */
let pageSnippets=new function(){const e="https://github.com/suppenhuhn79/pagesnippets",t="http://www.w3.org/1999/xhtml";let n=new XMLSerializer,r=new Map;function i(e,t=!1){return e.constructor===Array&&(e=e.join("/")),("/"+e+(!0===t?"/":"")).replace(/\/+/g,"/")}function o(e,t,r){let i=n.serializeToString(e);return i.substring(0,i.indexOf(">")+1)+"\t@"+t+"\n"+r}function c(e){return e.replace(/\sxmlns(=|:[^=]+=)"[^"]+"/gi,"").trim()}this.import=function(n){return new Promise(((i,c)=>{Array.from(r.values()).filter((e=>e.source===n)).length>0?i():fetch(n).then((a=>{function l(e){let t="";if(/^(http[s]?:\/\/|\/)/.test(e))t=e;else{let r=n.replace(/[^./]+\.[\S]+$/,"");e=e.replace(/^\.\//,""),t=r.concat(e).replace(/[^/]+\/\.\.\//g,"")}return t}function s(t,r,i){let c=[];for(let a of t.children){let t=o(a,n,i);if(a.namespaceURI===e)if("snippet"===a.localName)u(a,r,t);else if("snippet-group"===a.localName){let e=a.getAttribute("name");s(a,r+"/"+e,t)}else""===r&&"stylesheet"===a.localName?p(a):""===r&&"script"===a.localName&&c.push(a)}""===r&&f(c)}function u(e,i,o){let c=i+"/"+e.getAttribute("name");r.set(c,{source:n,key:c,namespace:e.firstElementChild.namespaceURI||t,data:e.firstElementChild}),e.childElementCount}function p(e){let t=l(e.getAttribute("src"));if(null===document.querySelector('link[rel="stylesheet"][href="'+t+'"]')){let e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("href",t),document.head.appendChild(e)}}function f(e){function t(t){"error"===t.type||f(e.slice(1))}if(e.length>0){let n=l(e[0].getAttribute("src"));if(null===document.querySelector('script[src="'+n+'"]')){let e=document.createElement("script");e.addEventListener("load",t),e.addEventListener("error",t),e.setAttribute("src",n),document.head.appendChild(e)}else f(e.slice(1))}else i()}if(200===a.status)a.text().then((t=>{let r;try{r=(new DOMParser).parseFromString(t,"text/xml")}finally{if(r.documentElement.namespaceURI===e&&"pagesnippets"===r.documentElement.localName)s(r.firstElementChild,"","");else{let e=new Error('"'+n+'" is not a PageSnippets XML-document.');c(e)}}}));else{let e=new ReferenceError("Server returned "+a.status+" ("+a.statusText+") when trying to fetch "+a.url);c(e)}}),(e=>{c(new Error(e))}))}))},this.produce=function(n,a={},l=""){function s(e,t,n="."){let r;if(e&&t){let i=t.split(n);r=1===i.length?e[i[0]]:s(e[i[0]],i.splice(1).join(n),n)}return r}function u(e,t){let n=e,r=/\{\{(.*?)\}\}/g,i=r.exec(e);for(;i;){let o=s(t,i[1])??"";n=n.replace(i[0],o instanceof Date?o.toISOString():o.toString()),i=r.exec(e)}return n}function p(n,r,i,c){for(let a of n.childNodes)switch(a.nodeType){case 1:let n=o(a,y,c);if(a.namespaceURI===e)switch(a.localName){case"call-function":h(a,r,i,n);break;case"choose":b(a,r,i,n);break;case"for-each":m(a,r,i,n);break;case"for-empty":g(a,r,i,n);break;case"if":w(a,r,i,n);break;case"insert-snippet":S(a,r,i,n);break;case"text":r.appendChild(document.createTextNode(u(a.firstChild.data,i)));break;default:}else{let e=document.createElementNS(a.namespaceURI||t,a.tagName);f(a,e,i,n),p(a,e,i,n),d(a,e,i,n),r.appendChild(e)}break;case 3:!1===/^\s*$/.test(a.textContent)&&r.appendChild(document.createTextNode(u(a.textContent,i)));break}}function f(t,n,r,i){for(let i of t.attributes)if(i.namespaceURI===e)if(/^on\S+/.test(i.localName)){let e=s(r,i.value);"function"==typeof e&&(n[i.localName]=e)}else i.localName;else n.setAttributeNS(i.namespaceURI,i.localName,u(i.value,r))}function d(t,n,r,i){let o=t.getAttributeNS(e,"postproduction");if(o){n.removeAttributeNS(e,"postproduction");let t=s(r,o);if("function"!=typeof t)throw new ReferenceError('Post-production reference "'+o+'" is not a function.\n'+c(i));t(n,r)}}function h(t,n,r,i){let o=t.getAttributeNS(e,"name")||t.getAttribute("name");if("function"!=typeof r[o])throw new ReferenceError('Reference to call "'+o+'" is not a function.\n'+c(i));r[o](n,r)}function m(t,n,r,i){let o=t.getAttributeNS(e,"list")||t.getAttribute("list"),a=s(r,o);if(a?.constructor!==Array)throw new TypeError('"'+o+'" is '+(a?.constructor.name??"undefined")+", expected Array.\n"+c(i));{let e=0,o=a.length;for(let c of a){let a=["string","number","boolean"].includes(typeof c)||c.constructor===Array?{_value:c}:Object.assign({},c);a._position=e+=1,a._count=o,p(t,n,Object.assign({},r,a),i)}}}function g(t,n,r,i){let o=s(r,t.getAttributeNS(e,"list")||t.getAttribute("list"));o?.constructor===Array&&0!==o.length||p(t,n,r,i)}function b(t,n,r,i){const c="strict";let a=(RegExp("^strict$|^lax$").exec(t.getAttribute("mode")||c)||[""])[0];""===a&&(a=c);let l=!1;for(let s of t.children){let t=o(s,y,i);if(s.namespaceURI===e&&"if"===s.localName){let e=w(s,n,r,t);if(l=l||e,l&&a===c)break}else s.namespaceURI===e&&"else"===s.localName&&!1===l&&p(s,n,r,t)}}function w(t,n,r,i){let o,a=t.getAttributeNS(e,"test")||t.getAttribute("test"),l="return ("+a.replace(/'?\{\{/g,"this.").replace(/\}\}'?/g,"")+")";try{o=Function(l).call(r)}catch(e){throw new e.constructor('Cannot evaluate expression "'+a+'": '+e.message+".\n"+c(i))}return!0===o&&p(t,n,r,i),o}function S(t,n,o,a){let l=i(u(t.getAttributeNS(e,"name")||t.getAttribute("name"),o));if(!r.has(l))throw new ReferenceError('Unknown snippet "'+l+'".\n'+c(a));n.appendChild(pageSnippets.produce(l,o,a))}if(!1===["string","undefined"].includes(typeof l))throw new TypeError("Prohibited usage of _parentSnippetRef");let y;if(n=i(n),this.getSnippet(n)){let e=r.get(n);if(l.includes(e.source+":"+n))throw new Error("Recursive snippet nesting.\n"+c(l));let t=o(e.data,e.source+":"+n,l),i=document.createElementNS(e.namespace,e.data.localName);return y=e.source+":"+n,f(e.data,i,a),p(e.data,i,a,t),d(e.data,i,a,t),i}},this.hasSnippet=function(e){return r.has(e)},this.getSnippet=function(e){if(r.has(e))return r.get(i(e));throw new ReferenceError('No such snippet: "'+e+'".')},this.getSnippets=function(e="",t=!1){let n=[],o=new RegExp("^("+i(e,!0)+"[^/]+)$");if(e=i(e,!0),n=n.concat(Array.from(r.keys()).filter((e=>o.test(e)))),!0===t)for(let t of this.getSnippetGroups(e))n=n.concat(this.getSnippets(t,!0));return n},this.getSnippetGroups=function(e="",t=!1){let n=new RegExp("^("+i(e,!0)+"[^/]+/)"),o=new Set;for(let e of r.keys()){let r=n.exec(e);r&&!1===o.has(r[1])&&(o.add(r[1]),!0===t&&this.getSnippetGroups(r[1],t).forEach((e=>o.add(e))))}return Array.from(o)}};